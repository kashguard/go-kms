services:
  service:
    build:
      context: .
      target: development
    ports:
      - "8080:8080"
    working_dir: &PROJECT_ROOT_DIR /app
    # linux permissions / vscode support: we must explicitly run as the development user
    user: development
    volumes:
      # mount working directory
      # https://code.visualstudio.com/docs/remote/containers-advanced#_update-the-mount-consistency-to-delegated-for-macos
      # https://docs.docker.com/docker-for-mac/osxfs-caching/#delegated
      # the containerâ€™s view is authoritative (permit delays before updates on the container appear in the host)
      - .:/app:delegated

      # mount cached go pkg downloads
      - go-pkg:/go/pkg

      # speed up tmp dirs in working directory by using separate volumes (not the host's filesystem)
      - workdir-api-tmp:/app/api/tmp
      - workdir-bin:/app/bin
      - workdir-tmp:/app/tmp

      # mount cached vscode container extensions
      # https://code.visualstudio.com/docs/remote/containers-advanced#_avoiding-extension-reinstalls-on-container-rebuild
      - vscode-extensions:/home/development/.vscode-server/extensions
      - vscode-extensions-insiders:/home/development/.vscode-server-insiders/extensions

      # https://code.visualstudio.com/remote/advancedcontainers/persist-bash-history
      # keep user development .bash_history between container restarts
      - bash-history:/home/development/commandhistory
      # persist SoftHSM tokens across restarts
      - softhsm-data:/home/development/.config/softhsm2

    depends_on:
      - postgres
      - integresql
    environment:
      # required: env for main working database, service
      # default for sql-migrate (target development) and psql cli tool
      PGDATABASE: &PGDATABASE "kms-dev"
      PGUSER: &PGUSER "dbuser"
      PGPASSWORD: &PGPASSWORD "dbpass"
      PGHOST: &PGHOST "postgres"
      PGPORT: &PGPORT "5432"
      PGSSLMODE: &PGSSLMODE "disable"

      # optional: env for sql-boiler (ability to generate models out of a "spec" database)
      # sql-boiler should operate on a "spec" database only
      PSQL_DBNAME: "spec"
      PSQL_USER: *PGUSER
      PSQL_PASS: *PGPASSWORD
      PSQL_HOST: *PGHOST
      PSQL_PORT: *PGPORT
      PSQL_SSLMODE: *PGSSLMODE

      # optional: project root directory, used for relative path resolution (e.g. fixtures)
      PROJECT_ROOT_DIR: *PROJECT_ROOT_DIR

      # optional: env for integresql client testing
      # INTEGRESQL_CLIENT_BASE_URL: "http://integresql:5000/api"

      # optional: enable pretty print of log output
      # intended use is for development and debugging purposes only
      # not recommended to enable on production systems due to performance penalty and loss of parsing ability
      SERVER_LOGGER_PRETTY_PRINT_CONSOLE: "true"

      # optional: static management secret to easily call http://localhost:8080/-/healthy?mgmt-secret=mgmtpass
      SERVER_MANAGEMENT_SECRET: "mgmtpass"

      # path to the changie config
      CHANGIE_CONFIG_PATH: "/app/.changie-go-starter.yaml"

      # KMS HSM configuration
      # Note: KMS_HSM_LIBRARY and KMS_HSM_SLOT will be auto-detected by init-softhsm.sh if not set
      KMS_STORAGE_BACKEND: "postgresql"
      KMS_HSM_TYPE: "software"
      # KMS_HSM_LIBRARY: ""  # Leave empty to auto-detect, or set to specific path
      # KMS_HSM_SLOT: "0"  # Leave empty to auto-detect, or set to specific slot
      KMS_HSM_PIN: "1234"
      KMS_HSM_LABEL: "KMS"
      KMS_ENABLE_AUDIT: "true"
      KMS_ENABLE_POLICY: "true"
      KMS_ENABLE_SECRET_SERVICE: "true"
      KMS_SECRET_KEY_ID: "key-f3081526-18b5-47f2-88dd-58cf59f5be4d"
      # Use custom OpenSSL 3.2.2 for Ed25519 support
      LD_LIBRARY_PATH: "/home/development/openssl-ed25519/lib:/opt/openssl-ed25519/lib:/usr/lib/aarch64-linux-gnu:/lib/aarch64-linux-gnu"

    # Uncomment the next four lines if you will use a ptrace-based debugger like C++, Go, and Rust.
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined

    # Overrides default command so things don't shut down after the process ends.
    command:
      - /bin/sh
      - -c
      - |
        sudo chown -R development:development /app/api/tmp
        sudo chown -R development:development /app/bin
        sudo chown -R development:development /app/tmp
        sudo mkdir -p /home/development/.config/softhsm2
        sudo chown -R development:development /home/development/.config/softhsm2
        chmod +x /app/rksh
        git config --global --add safe.directory /app
        # Initialize SoftHSM if KMS is enabled
        if [ -n "$$KMS_HSM_TYPE" ] && [ "$$KMS_HSM_TYPE" = "software" ]; then
          echo "Initializing SoftHSM..."
          # Copy OpenSSL libraries from build directory if not already installed
          OPENSSL_BUILD_DIR=$$(find /app/tmp -type d -name 'openssl-3.2.2' -exec test -f {}/libcrypto.so.3 \; -print 2>/dev/null | head -1)
          if [ -n "$$OPENSSL_BUILD_DIR" ] && [ ! -d /home/development/openssl-ed25519/lib ]; then
            echo "Copying OpenSSL libraries from build directory..."
            mkdir -p /home/development/openssl-ed25519/lib
            cp "$$OPENSSL_BUILD_DIR/libcrypto.so"* "$$OPENSSL_BUILD_DIR/libssl.so"* /home/development/openssl-ed25519/lib/ 2>/dev/null || true
            echo "OpenSSL libraries copied to /home/development/openssl-ed25519/lib"
          fi
          # Set LD_LIBRARY_PATH to use custom OpenSSL 3.2.2 (for Ed25519 support)
          if [ -d /home/development/openssl-ed25519/lib ] && [ -f /home/development/openssl-ed25519/lib/libcrypto.so.3 ]; then
            export LD_LIBRARY_PATH="/home/development/openssl-ed25519/lib:$$LD_LIBRARY_PATH"
            echo "Using custom OpenSSL from /home/development/openssl-ed25519/lib"
          elif [ -d /opt/openssl-ed25519/lib ]; then
            export LD_LIBRARY_PATH="/opt/openssl-ed25519/lib:$$LD_LIBRARY_PATH"
            echo "Using custom OpenSSL from /opt/openssl-ed25519/lib"
          fi
          /app/scripts/init-softhsm.sh || echo "Warning: SoftHSM initialization failed, but continuing..."
          # Load auto-detected library path if available
          if [ -f /tmp/kms_hsm_library ]; then
            export KMS_HSM_LIBRARY="$$(cat /tmp/kms_hsm_library)"
            echo "Using auto-detected SoftHSM library: $$KMS_HSM_LIBRARY"
          fi
          # Load auto-detected slot if available (overrides environment variable)
          if [ -f /tmp/kms_hsm_slot ]; then
            export KMS_HSM_SLOT="$$(cat /tmp/kms_hsm_slot)"
            echo "Using auto-detected SoftHSM slot: $$KMS_HSM_SLOT"
          fi
        fi
        while sleep 1000; do :; done

  postgres:
    image: postgres:17.4-alpine # should be the same version as used in .drone.yml, .github/workflows, Dockerfile and live
    # ATTENTION
    # fsync=off, synchronous_commit=off and full_page_writes=off
    # gives us a major speed up during local development and testing (~30%),
    # however you should NEVER use these settings in PRODUCTION unless
    # you want to have CORRUPTED data.
    # DO NOT COPY/PASTE THIS BLINDLY.
    # YOU HAVE BEEN WARNED.
    # Apply some performance improvements to pg as these guarantees are not needed while running locally
    command: "postgres -c 'shared_buffers=128MB' -c 'fsync=off' -c 'synchronous_commit=off' -c 'full_page_writes=off' -c 'max_connections=100' -c 'client_min_messages=warning'"
    expose:
      - "5432"
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: *PGDATABASE
      POSTGRES_USER: *PGUSER
      POSTGRES_PASSWORD: *PGPASSWORD
    volumes:
      - pgvolume:/var/lib/postgresql/data

  integresql:
    image: ghcr.io/allaboutapps/integresql:v1.1.0
    expose:
      - "5000"
    depends_on:
      - postgres
    environment:
      PGHOST: *PGHOST
      PGUSER: *PGUSER
      PGPASSWORD: *PGPASSWORD

  mailhog:
    image: mailhog/mailhog
    expose:
      - "1025"
    ports:
      - "8025:8025"

  swaggerui:
    image: swaggerapi/swagger-ui:v3.46.0
    environment:
      SWAGGER_JSON: "/api/swagger.yml"
    volumes:
      # mount our local main swagger.yml file (refresh your browser to see changes)
      - ./api:/api:ro,consistent
      # mount overwritten translator.js (intercept requests port 8081 to our local service on port 8080)
      - ./api/config/swagger-ui-local-translator.js:/usr/share/nginx/configurator/translator.js:ro,delegated

  swaggerui-browser-sync:
    image: allaboutapps/browser-sync:v2.26.14
    command: start --proxy 'swaggerui:8080' --port 8081 --files "/api/*.yml"
    volumes:
      - ./api:/api:ro,consistent
    ports:
      - "8081:8081"

volumes:
  # postgresql: declare a named volume to persist DB data
  pgvolume:

  # go: go mod cached downloads
  go-pkg:

  # tmp dirs in workdir
  workdir-api-tmp:
  workdir-bin:
  workdir-tmp:

  # vscode: Avoiding extension reinstalls on container rebuild
  # https://code.visualstudio.com/docs/remote/containers-advanced#_avoiding-extension-reinstalls-on-container-rebuild
  vscode-extensions:
  vscode-extensions-insiders:

  # https://code.visualstudio.com/remote/advancedcontainers/persist-bash-history
  bash-history:
  softhsm-data:
